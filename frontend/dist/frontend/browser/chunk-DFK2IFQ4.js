import{a as R}from"./chunk-VHJLDOQG.js";import{b as F,c as B,f as L,p as $}from"./chunk-AKKU7WAO.js";import{a as H}from"./chunk-JJRD7MNC.js";import"./chunk-YRFZ7VUJ.js";import{Aa as P,Ba as w,C as b,E as s,I as k,La as N,R as _,S as u,Sa as j,U as M,Ua as A,V as y,W as v,X as r,Y as a,Z as m,da as O,fa as C,ha as d,ia as T,ja as E,ka as I,na as x,pa as c,qa as h,r as S,s as g,t as p,ta as U,ua as z,va as V,x as f,za as D}from"./chunk-AY3CH6AK.js";var q=["messagesContainer"],J=o=>["/profile",o],G=(o,e)=>e._id,K=(o,e)=>e._id||o;function X(o,e){o&1&&(r(0,"div",5),m(1,"div",10),a())}function Y(o,e){o&1&&(r(0,"div",6),m(1,"i",11),r(2,"p"),c(3,"No conversations yet"),a(),r(4,"p",12),c(5,"Start chatting from a user's profile!"),a()())}function Z(o,e){if(o&1&&(r(0,"span",20),c(1),a()),o&2){let t=d().$implicit;s(),h(t.unreadCount)}}function ee(o,e){if(o&1){let t=O();r(0,"div",14),C("click",function(){let i=g(t).$implicit,l=d(2);return p(l.selectConversation(i))}),m(1,"img",15),P(2,"photoUrl"),r(3,"div",16)(4,"h4"),c(5),a(),r(6,"p",17),c(7),a()(),r(8,"div",18)(9,"span",19),c(10),a(),_(11,Z,2,1,"span",20),a()()}if(o&2){let t,n=e.$implicit,i=d(2);x("active",((t=i.activeConversation())==null?null:t._id)===n._id),s(),v("src",w(2,7,n.otherUser==null?null:n.otherUser.profilePhotoUrl)||i.getPlaceholderImg(n.otherUser==null?null:n.otherUser.gender),b),s(4),h((n.otherUser==null?null:n.otherUser.fullName)||"Unknown"),s(2),h(n.lastMessage||"No messages yet"),s(3),h(i.getTimeAgo(n.lastMessageAt)),s(),u(n.unreadCount>0?11:-1)}}function te(o,e){if(o&1&&(r(0,"div",7),M(1,ee,12,9,"div",13,G),a()),o&2){let t=d();s(),y(t.conversations())}}function ne(o,e){o&1&&(r(0,"div",9),m(1,"i",21),r(2,"p"),c(3,"Select a conversation to start chatting"),a()())}function ie(o,e){o&1&&(r(0,"span",27),c(1,"typing..."),a())}function oe(o,e){o&1&&(r(0,"div",30),m(1,"span",36),c(2," Loading older messages..."),a())}function re(o,e){if(o&1&&(r(0,"div",37)(1,"p",38),c(2),a(),r(3,"span",39),c(4),a()()),o&2){let t=e.$implicit,n=d(2);x("mine",t.senderId===n.currentUserId)("theirs",t.senderId!==n.currentUserId),s(2),h(t.text),s(2),h(n.getTimeAgo(t.createdAt))}}function ae(o,e){if(o&1){let t=O();r(0,"div",22)(1,"button",23),C("click",function(){g(t);let i=d();return p(i.activeConversation.set(null))}),m(2,"i",24),a(),m(3,"img",25),P(4,"photoUrl"),r(5,"div",26)(6,"h3"),c(7),a(),_(8,ie,2,0,"span",27),a(),r(9,"a",28),c(10,"View Profile"),a()(),r(11,"div",29,0),C("scroll",function(){g(t);let i=d();return p(i.onMessagesScroll())}),_(13,oe,3,0,"div",30),M(14,re,5,6,"div",31,K),a(),r(16,"div",32)(17,"input",33),V("ngModelChange",function(i){g(t);let l=d();return z(l.newMessage,i)||(l.newMessage=i),p(i)}),C("keyup.enter",function(){g(t);let i=d();return p(i.sendMessage())})("input",function(){g(t);let i=d();return p(i.onTyping())}),a(),r(18,"button",34),C("click",function(){g(t);let i=d();return p(i.sendMessage())}),m(19,"i",35),a()()}if(o&2){let t,n,i,l=d();s(3),v("src",w(4,7,(t=l.activeConversation().otherUser)==null?null:t.profilePhotoUrl)||l.getPlaceholderImg((t=l.activeConversation().otherUser)==null?null:t.gender),b),s(4),h(((n=l.activeConversation().otherUser)==null?null:n.fullName)||"Unknown"),s(),u(l.chatService.typingUser()?8:-1),s(),v("routerLink",D(9,J,((i=l.activeConversation().otherUser)==null?null:i._id)||((i=l.activeConversation().otherUser)==null?null:i.profileId))),s(4),u(l.loadingOlder()?13:-1),s(),y(l.chatService.messages()),s(3),U("ngModel",l.newMessage),s(),v("disabled",!l.newMessage.trim())}}var Q=class o{chatService=S(R);conversations=f([]);activeConversation=f(null);loading=f(!0);loadingOlder=f(!1);hasMoreOlder=f(!0);nextCursor=f(null);newMessage="";currentUserId="";messagesContainer;ngOnInit(){try{let e=JSON.parse(localStorage.getItem("khubool_user")||"{}");this.currentUserId=e._id||e.id||""}catch{}this.chatService.connect(),this.loadConversations()}ngOnDestroy(){}async loadConversations(){this.loading.set(!0);try{let e=await this.chatService.getConversations();this.conversations.set(e.conversations||[])}catch{this.conversations.set([])}this.loading.set(!1)}async selectConversation(e){this.activeConversation.set(e),this.chatService.joinConversation(e._id),this.hasMoreOlder.set(!0),this.nextCursor.set(null);try{let t=await this.chatService.getMessages(e._id),n=t.messages||[];this.chatService.messages.set(n),this.hasMoreOlder.set(t.hasMore),this.nextCursor.set(t.nextCursor)}catch{this.chatService.messages.set([])}this.scrollToBottom()}sendMessage(){if(!this.newMessage.trim()||!this.activeConversation())return;let e=this.activeConversation()._id;this.chatService.sendMessage(e,this.newMessage.trim()),this.chatService.messages.update(t=>[...t,{senderId:this.currentUserId,text:this.newMessage.trim(),createdAt:new Date().toISOString(),_id:"temp_"+Date.now()}]),this.newMessage="",this.chatService.emitStopTyping(e),this.scrollToBottom()}async onMessagesScroll(){let e=this.messagesContainer?.nativeElement;if(!e||this.loadingOlder()||!this.hasMoreOlder()||!this.activeConversation()||e.scrollTop>100)return;let t=this.nextCursor();if(t){this.loadingOlder.set(!0);try{let n=await this.chatService.getMessages(this.activeConversation()._id,t),i=n.messages||[];if(i.length){let l=e.scrollHeight;this.chatService.messages.update(W=>[...i,...W]),this.hasMoreOlder.set(n.hasMore),this.nextCursor.set(n.nextCursor),setTimeout(()=>{e.scrollTop=e.scrollHeight-l},0)}else this.hasMoreOlder.set(!1)}catch{}this.loadingOlder.set(!1)}}onTyping(){this.activeConversation()&&this.chatService.emitTyping(this.activeConversation()._id)}scrollToBottom(){setTimeout(()=>{let e=this.messagesContainer?.nativeElement;e&&(e.scrollTop=e.scrollHeight)},50)}getTimeAgo(e){if(!e)return"";let t=Date.now()-new Date(e).getTime(),n=Math.floor(t/6e4);if(n<1)return"just now";if(n<60)return`${n}m`;let i=Math.floor(n/60);return i<24?`${i}h`:`${Math.floor(i/24)}d`}getPlaceholderImg(e){return e==="female"?"assets/bride.png":"assets/groom.png"}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=k({type:o,selectors:[["app-chat"]],viewQuery:function(t,n){if(t&1&&T(q,5),t&2){let i;E(i=I())&&(n.messagesContainer=i.first)}},decls:11,vars:6,consts:[["messagesContainer",""],[1,"chat-container"],[1,"chat-sidebar"],[1,"chat-heading"],[1,"fa-solid","fa-comments"],[1,"chat-loading"],[1,"chat-empty"],[1,"conversation-list"],[1,"chat-main"],[1,"no-chat-selected"],[1,"spinner"],[1,"fa-solid","fa-comment-dots"],[1,"hint"],[1,"conversation-item",3,"active"],[1,"conversation-item",3,"click"],["loading","lazy","alt","",1,"conv-avatar",3,"src"],[1,"conv-info"],[1,"last-msg"],[1,"conv-meta"],[1,"time"],[1,"unread-badge"],[1,"fa-solid","fa-message"],[1,"chat-header"],[1,"btn-back",3,"click"],[1,"fa-solid","fa-arrow-left"],["loading","lazy","alt","",1,"header-avatar",3,"src"],[1,"header-info"],[1,"typing-indicator"],[1,"btn-view-profile",3,"routerLink"],[1,"messages-container",3,"scroll"],[1,"load-older"],[1,"message-bubble",3,"mine","theirs"],[1,"chat-input-bar"],["type","text","placeholder","Type a message...","autocomplete","off",1,"chat-input",3,"ngModelChange","keyup.enter","input","ngModel"],[1,"btn-send",3,"click","disabled"],[1,"fa-solid","fa-paper-plane"],[1,"spinner-small"],[1,"message-bubble"],[1,"msg-text"],[1,"msg-time"]],template:function(t,n){t&1&&(r(0,"div",1)(1,"div",2)(2,"h2",3),m(3,"i",4),c(4," Messages"),a(),_(5,X,2,0,"div",5)(6,Y,6,0,"div",6)(7,te,3,0,"div",7),a(),r(8,"div",8),_(9,ne,4,0,"div",9)(10,ae,20,11),a()()),t&2&&(s(),x("hidden-on-mobile",n.activeConversation()),s(4),u(n.loading()?5:n.conversations().length===0?6:7),s(3),x("hidden-on-mobile",!n.activeConversation()),s(),u(n.activeConversation()?10:9))},dependencies:[N,$,F,B,L,A,j,H],styles:[".chat-container[_ngcontent-%COMP%]{display:flex;height:calc(100vh - 80px);background:#f8fafc;border-radius:16px;overflow:hidden;border:1px solid #e2e8f0;font-family:Inter,Segoe UI,system-ui,sans-serif}.chat-sidebar[_ngcontent-%COMP%]{width:340px;min-width:280px;border-right:1px solid #e2e8f0;background:#fff;display:flex;flex-direction:column}.chat-heading[_ngcontent-%COMP%]{padding:1.25rem 1.5rem;font-size:1.25rem;font-weight:700;color:#1e293b;border-bottom:1px solid #f1f5f9;margin:0}.chat-heading[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#db2777;margin-right:.5rem}.conversation-list[_ngcontent-%COMP%]{overflow-y:auto;flex:1}.conversation-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:.85rem 1.25rem;cursor:pointer;border-bottom:1px solid #f8fafc;transition:background .15s}.conversation-item[_ngcontent-%COMP%]:hover{background:#f8fafc}.conversation-item.active[_ngcontent-%COMP%]{background:#fdf2f8;border-left:3px solid #db2777}.conv-avatar[_ngcontent-%COMP%]{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #fce7f3;flex-shrink:0}.conv-info[_ngcontent-%COMP%]{flex:1;min-width:0}.conv-info[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0;font-size:.95rem;font-weight:600;color:#1e293b}.last-msg[_ngcontent-%COMP%]{margin:.15rem 0 0;font-size:.8rem;color:#94a3b8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.conv-meta[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:flex-end;gap:.35rem;flex-shrink:0}.conv-meta[_ngcontent-%COMP%]   .time[_ngcontent-%COMP%]{font-size:.7rem;color:#94a3b8}.unread-badge[_ngcontent-%COMP%]{background:#db2777;color:#fff;font-size:.65rem;font-weight:700;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center}.chat-main[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;background:#fefefe}.no-chat-selected[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#94a3b8}.no-chat-selected[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:3rem;margin-bottom:1rem}.no-chat-selected[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:1rem}.chat-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:.85rem 1.25rem;border-bottom:1px solid #e2e8f0;background:#fff}.btn-back[_ngcontent-%COMP%]{display:none;background:none;border:none;font-size:1.1rem;color:#64748b;cursor:pointer}.header-avatar[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #fce7f3}.header-info[_ngcontent-%COMP%]{flex:1}.header-info[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:1rem;font-weight:600;color:#1e293b}.typing-indicator[_ngcontent-%COMP%]{font-size:.75rem;color:#10b981;font-style:italic;animation:_ngcontent-%COMP%_pulse 1.5s ease-in-out infinite}@keyframes _ngcontent-%COMP%_pulse{0%,to{opacity:.5}50%{opacity:1}}.btn-view-profile[_ngcontent-%COMP%]{padding:.35rem .85rem;border-radius:8px;background:#f1f5f9;color:#64748b;text-decoration:none;font-size:.8rem;font-weight:600;transition:all .2s}.btn-view-profile[_ngcontent-%COMP%]:hover{background:#e2e8f0;color:#1e293b}.messages-container[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:1.25rem;display:flex;flex-direction:column;gap:.75rem}.message-bubble[_ngcontent-%COMP%]{max-width:75%;padding:.65rem 1rem;border-radius:16px;position:relative}.message-bubble.mine[_ngcontent-%COMP%]{align-self:flex-end;background:linear-gradient(135deg,#db2777,#be185d);color:#fff;border-bottom-right-radius:4px}.message-bubble.theirs[_ngcontent-%COMP%]{align-self:flex-start;background:#f1f5f9;color:#1e293b;border-bottom-left-radius:4px}.msg-text[_ngcontent-%COMP%]{margin:0;font-size:.9rem;line-height:1.45}.msg-time[_ngcontent-%COMP%]{display:block;font-size:.65rem;margin-top:.25rem;opacity:.7;text-align:right}.message-bubble.theirs[_ngcontent-%COMP%]   .msg-time[_ngcontent-%COMP%]{text-align:left}.chat-input-bar[_ngcontent-%COMP%]{display:flex;gap:.5rem;padding:.85rem 1.25rem;border-top:1px solid #e2e8f0;background:#fff}.chat-input[_ngcontent-%COMP%]{flex:1;padding:.65rem 1rem;border-radius:24px;border:1px solid #e2e8f0;font-size:.9rem;outline:none;transition:border-color .2s}.chat-input[_ngcontent-%COMP%]:focus{border-color:#db2777}.btn-send[_ngcontent-%COMP%]{width:42px;height:42px;border-radius:50%;background:#db2777;color:#fff;border:none;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s}.btn-send[_ngcontent-%COMP%]:hover{background:#be185d}.btn-send[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.chat-loading[_ngcontent-%COMP%], .chat-empty[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#94a3b8;padding:2rem;text-align:center}.chat-empty[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:2.5rem;color:#cbd5e1;margin-bottom:.75rem}.chat-empty[_ngcontent-%COMP%]   .hint[_ngcontent-%COMP%]{font-size:.8rem;color:#cbd5e1}.spinner[_ngcontent-%COMP%]{width:32px;height:32px;border:3px solid #f3f4f6;border-top-color:#db2777;border-radius:50%;animation:_ngcontent-%COMP%_spin 1s linear infinite}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}@media(max-width:768px){.chat-container[_ngcontent-%COMP%]{height:calc(100vh - 6rem);border-radius:8px;width:100%;border:none}.chat-sidebar[_ngcontent-%COMP%]{width:100%;min-width:0;border-right:none}.chat-sidebar.hidden-on-mobile[_ngcontent-%COMP%], .chat-main.hidden-on-mobile[_ngcontent-%COMP%]{display:none}.btn-back[_ngcontent-%COMP%]{display:block}}"]})};export{Q as ChatComponent};
